// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
    provider = "prisma-client-js"
    output   = "../generated/prisma"
}

datasource db {
    provider  = "postgresql"
    url       = env("DATABASE_URL")
    directUrl = env("DIRECT_URL")
}

// ============ USER & AUTH ============

enum UserRole {
    ADMIN
    MANAGER
    STAFF
    CUSTOMER
}

model User {
    id            String    @id @default(cuid())
    name          String?
    email         String?   @unique
    emailVerified DateTime?
    image         String?
    password      String?   // For credentials-based auth (hashed with bcrypt)
    role          UserRole  @default(CUSTOMER)
    accounts      Account[]
    sessions      Session[]
    posts         Post[]
    customer      Customer?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
}

// Necessary for Next auth
model Account {
    id                       String  @id @default(cuid())
    userId                   String
    type                     String
    provider                 String
    providerAccountId        String
    refresh_token            String? // @db.Text
    access_token             String? // @db.Text
    expires_at               Int?
    token_type               String?
    scope                    String?
    id_token                 String? // @db.Text
    session_state            String?
    user                     User    @relation(fields: [userId], references: [id], onDelete: Cascade)
    refresh_token_expires_in Int?

    @@unique([provider, providerAccountId])
}

model Session {
    id           String   @id @default(cuid())
    sessionToken String   @unique
    userId       String
    expires      DateTime
    user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
    identifier String
    token      String   @unique
    expires    DateTime

    @@unique([identifier, token])
}

// Sample post model (can be removed later)
model Post {
    id        Int      @id @default(autoincrement())
    name      String
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    createdBy   User   @relation(fields: [createdById], references: [id])
    createdById String

    @@index([name])
}

// ============ CATEGORIES ============

model Category {
    id          String  @id @default(cuid())
    name        String  @unique
    slug        String  @unique
    description String?
    image       String?
    position    Int     @default(0)
    featured    Boolean @default(false)

    // Relations
    products Product[]

    // Timestamps
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([slug])
    @@index([position])
}

// ============ PRODUCTS ============

enum ProductStatus {
    DRAFT
    ACTIVE
    ARCHIVED
}

model Product {
    id          String   @id @default(cuid())
    sku         String   @unique
    name        String
    slug        String   @unique
    description String?

    // Pricing
    price     Float
    salePrice Float?
    costPrice Float? // For profit tracking

    // Categorization
    categoryId       String?
    categoryRelation Category? @relation(fields: [categoryId], references: [id])
    category         String?   // Legacy - will be removed after migration
    subcategory      String?

    // Inventory
    stockQuantity     Int     @default(0)
    lowStockThreshold Int     @default(5)
    trackInventory    Boolean @default(true)

    // Media
    images   ProductImage[]
    gradient String? // For display styling

    // ============ PRODUCT SPECIFICATIONS ============
    // Common specs (all product types)
    modelNumber String? // Model # or Item #
    size        String? // Dimensions like "14' H x 23' L x 11' W"
    weight      Float?  // Unit weight in lbs (from HTML table, NOT shipping weight)
    warranty    String? // e.g., "12 Months", "6 Months"

    // Inflatable specs (bouncers, slides, combos, obstacle courses)
    pieces    Int?     // Number of pieces
    blowers   Int?     // Number of blowers required
    operators Int?     // Number of operators needed
    riders    String?  // Capacity like "4-6" or "8-10"
    indoor    Boolean? // Can be used indoors
    outdoor   Boolean? // Can be used outdoors

    // Motor/Blower specs
    power     String? // e.g., "1 HP", "1.5 HP"
    voltage   String? // e.g., "115 V"
    frequency String? // e.g., "60 HZ"
    phase     String? // e.g., "Single"
    rpm       Int?    // e.g., 3350
    amps      Float?  // e.g., 7.5

    // Legacy fields (keep for backward compatibility during migration)
    ageRange   String? // Deprecated - use riders instead
    dimensions String? // Deprecated - use size instead

    // ============ END SPECIFICATIONS ============

    // Status
    status   ProductStatus @default(DRAFT)
    badge    String? // NEW, POPULAR, SALE
    featured Boolean       @default(false)

    // SEO
    metaTitle       String?
    metaDescription String?

    // Relations
    orderItems OrderItem[]

    // Timestamps
    createdAt   DateTime  @default(now())
    updatedAt   DateTime  @updatedAt
    publishedAt DateTime?

    @@index([categoryId])
    @@index([status])
    @@index([sku])
}

model ProductImage {
    id        String  @id @default(cuid())
    url       String
    alt       String?
    position  Int     @default(0)
    productId String
    product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
}

// ============ CUSTOMERS ============

model Customer {
    id     String  @id @default(cuid())
    userId String? @unique
    user   User?   @relation(fields: [userId], references: [id])

    // Contact Info
    email     String  @unique
    phone     String?
    firstName String
    lastName  String
    company   String?

    // Addresses
    addresses Address[]

    // Communication Preferences
    emailMarketing Boolean @default(false)
    smsMarketing   Boolean @default(false)

    // Stats
    totalOrders Int   @default(0)
    totalSpent  Float @default(0)

    // Relations
    orders Order[]

    // Notes (admin only)
    notes String?
    tags  String? // Comma-separated tags

    // Timestamps
    createdAt   DateTime  @default(now())
    updatedAt   DateTime  @updatedAt
    lastOrderAt DateTime?

    @@index([email])
    @@index([lastName])
}

enum AddressType {
    SHIPPING
    BILLING
}

model Address {
    id         String   @id @default(cuid())
    customerId String
    customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

    type      AddressType @default(SHIPPING)
    isDefault Boolean     @default(false)

    firstName  String
    lastName   String
    company    String?
    address1   String
    address2   String?
    city       String
    state      String
    postalCode String
    country    String  @default("US")
    phone      String?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
}

// ============ ORDERS ============

enum OrderStatus {
    PENDING
    CONFIRMED
    PROCESSING
    SHIPPED
    DELIVERED
    CANCELLED
    REFUNDED
}

enum PaymentStatus {
    PENDING
    PAID
    PARTIALLY_PAID
    REFUNDED
    FAILED
}

enum FulfillmentStatus {
    UNFULFILLED
    PARTIALLY_FULFILLED
    FULFILLED
}

model Order {
    id          String @id @default(cuid())
    orderNumber String @unique // Human-readable: JJ-2024-0001

    // Customer
    customerId String
    customer   Customer @relation(fields: [customerId], references: [id])

    // Items
    items OrderItem[]

    // Pricing
    subtotal       Float
    taxAmount      Float @default(0)
    shippingAmount Float @default(0)
    discountAmount Float @default(0)
    totalAmount    Float

    // Status
    status            OrderStatus       @default(PENDING)
    paymentStatus     PaymentStatus     @default(PENDING)
    fulfillmentStatus FulfillmentStatus @default(UNFULFILLED)

    // Shipping
    shippingMethod  String?
    trackingNumber  String?
    trackingUrl     String?
    shippingCarrier String? // UPS, FedEx, USPS, etc.

    // Addresses (snapshot at order time - stored as JSON string)
    shippingAddress String // JSON
    billingAddress  String // JSON

    // Payment
    paymentMethod String?
    paymentId     String? // Stripe/PayPal transaction ID

    // Notes
    customerNotes String?
    internalNotes String?

    // Timestamps
    createdAt   DateTime  @default(now())
    updatedAt   DateTime  @updatedAt
    paidAt      DateTime?
    shippedAt   DateTime?
    deliveredAt DateTime?
    cancelledAt DateTime?

    @@index([orderNumber])
    @@index([customerId])
    @@index([status])
    @@index([createdAt])
}

model OrderItem {
    id        String  @id @default(cuid())
    orderId   String
    order     Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
    productId String
    product   Product @relation(fields: [productId], references: [id])

    // Snapshot at order time
    sku        String
    name       String
    price      Float
    quantity   Int
    totalPrice Float

    // Options/variants if applicable (stored as JSON string)
    options String?
}

// ============ MAILING LIST / SUBSCRIBERS ============

model Subscriber {
    id        String  @id @default(cuid())
    email     String  @unique
    phone     String?
    firstName String?
    lastName  String?

    // Subscription status
    emailSubscribed Boolean @default(true)
    smsSubscribed   Boolean @default(false)

    // Source tracking
    source String? // website, checkout, import, etc.

    // Engagement
    confirmedAt    DateTime?
    unsubscribedAt DateTime?

    // Timestamps
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([email])
}

// ============ AUDIT LOG (Optional - for tracking admin actions) ============

model AuditLog {
    id        String   @id @default(cuid())
    userId    String
    action    String // CREATE, UPDATE, DELETE
    entity    String // Product, Order, Customer, etc.
    entityId  String
    oldValues String? // JSON of previous values
    newValues String? // JSON of new values
    ipAddress String?
    userAgent String?
    createdAt DateTime @default(now())

    @@index([userId])
    @@index([entity, entityId])
    @@index([createdAt])
}
